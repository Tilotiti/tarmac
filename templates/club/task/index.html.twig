{% extends 'club/base.html.twig' %}

{% block page_title %}
	{{ 'tasks'|trans }}
{% endblock %}

{% block page_actions %}
	<a href="{{ path('club_task_new') }}" class="btn btn-primary" style="min-height: 44px;">
		<i class="ti ti-plus me-2"></i>
		<span class="d-none d-sm-inline">{{ 'newTask'|trans }}</span>
		<span class="d-inline d-sm-none">{{ 'add'|trans }}</span>
	</a>
{% endblock %}

{% block page_content %}
	{% include 'component/filters.html.twig' with { form: filters } %}

	{# Task cards - Mobile-first design #}
	<div class="row">
		{% for task in tasks %}
			<div class="col-12 mb-3">
				<a href="{{ path('club_task_show', {id: task.id}) }}" class="text-decoration-none">
					<div class="card card-link" style="cursor: pointer;">
						<div class="card-body">
							<div
								class="d-flex align-items-start mb-3">
								{# Equipment Avatar - same style as equipment list #}
								<span class="avatar avatar-lg me-3 bg-{{ task.equipment.type.value == 'glider' ? 'blue' : (task.equipment.type.value == 'facility' ? 'purple' : 'green') }}-lt">
									<i class="ti ti-{{ task.equipment.type.value == 'glider' ? 'plane' : (task.equipment.type.value == 'facility' ? 'building' : 'tool') }} text-{{ task.equipment.type.value == 'glider' ? 'blue' : (task.equipment.type.value == 'facility' ? 'purple' : 'green') }}" style="font-size: 1.5rem;"></i>
								</span>

								{# Main content #}
								<div
									class="flex-grow-1">
									{# Equipment name (main title) #}
									<h3 class="card-title mb-1">
										{{ task.equipment.name }}
									</h3>

									{# Task name (subtitle) #}
									<div class="text-secondary mb-2">
										{{ task.title }}
									</div>

									{# Due date #}
									<div class="text-secondary small">
										{% if task.dueAt %}
											<i class="ti ti-calendar me-1"></i>
											{{ task.dueAt|date('d/m/Y') }}
										{% endif %}
									</div>
								</div>

								{# Badges on desktop - right side #}
								<div
									class="ms-3 d-none d-md-flex gap-2 align-items-start">
									{# Status badge with icon #}
									<span class="badge bg-{{ task.status == 'closed' ? 'success' : (task.status == 'cancelled' ? 'danger' : 'info') }} text-white">
										<i class="ti ti-{{ task.status == 'closed' ? 'circle-check' : (task.status == 'cancelled' ? 'x' : (task.status == 'done' ? 'check' : (task.status == 'claimed' ? 'hourglass' : 'circle'))) }} me-1"></i>
										{{ task.status|trans }}
									</span>

									{# Inspection badge with icon #}
									{% if task.requiresInspection %}
										<span class="badge bg-purple text-white">
											<i class="ti ti-eye-check me-1"></i>
											{{ 'inspection'|trans }}
										</span>
									{% endif %}

									{# Difficulty badge with icon and same style #}
									{% set difficultyMap = {
										1: 'debutant',
										2: 'facile',
										3: 'moyen',
										4: 'difficile',
										5: 'expert'
									} %}
									{% set difficultyColorMap = {
										1: 'success',
										2: 'info',
										3: 'warning',
										4: 'orange',
										5: 'danger'
									} %}
									<span class="badge bg-{{ difficultyColorMap[task.difficulty] }} text-white">
										<i class="ti ti-gauge me-1"></i>
										{{ difficultyMap[task.difficulty]|trans }}
									</span>
								</div>
							</div>

							{# Badges on mobile - full width under avatar #}
							<div
								class="d-flex d-md-none gap-2 flex-wrap mb-3">
								{# Status badge with icon #}
								<span class="badge bg-{{ task.status == 'closed' ? 'success' : (task.status == 'cancelled' ? 'danger' : 'info') }} text-white">
									<i class="ti ti-{{ task.status == 'closed' ? 'circle-check' : (task.status == 'cancelled' ? 'x' : (task.status == 'done' ? 'check' : (task.status == 'claimed' ? 'hourglass' : 'circle'))) }} me-1"></i>
									{{ task.status|trans }}
								</span>

								{# Inspection badge with icon #}
								{% if task.requiresInspection %}
									<span class="badge bg-purple text-white">
										<i class="ti ti-eye-check me-1"></i>
										{{ 'inspection'|trans }}
									</span>
								{% endif %}

								{# Difficulty badge with icon and same style #}
								<span class="badge bg-{{ difficultyColorMap[task.difficulty] }} text-white">
									<i class="ti ti-gauge me-1"></i>
									{{ difficultyMap[task.difficulty]|trans }}
								</span>
							</div>

							{# Progress bar at the bottom - full width #}
							{% if task.subTasks|length > 0 %}
								{% set progress = 0 %}
								{% set closed = 0 %}
								{% for subtask in task.subTasks %}
									{% if subtask.status == 'closed' %}
										{% set closed = closed + 1 %}
									{% endif %}
								{% endfor %}
								{% set progress = (closed / task.subTasks|length * 100)|round %}
								<div class="progress progress-sm mb-2">
									<div class="progress-bar bg-{{ progress == 100 ? 'success' : 'primary' }}" style="width: {{ progress }}%">
										<span class="visually-hidden">{{ progress }}%</span>
									</div>
								</div>
								<div class="text-secondary small">
									{{ closed }}
									/
									{{ task.subTasks|length }}
									{{ 'subTasks'|trans|lower }}
								</div>
							{% endif %}
						</div>
					</div>
				</a>
			</div>
		{% else %}
			<div class="col-12">
				<div class="card">
					<div class="card-body text-center text-secondary">
						<i class="ti ti-checklist" style="font-size: 3rem; opacity: 0.5;"></i>
						<p class="mt-3 mb-0">
							<em>{{ 'noTasksFound'|trans }}</em>
						</p>
						<a href="{{ path('club_task_new') }}" class="btn btn-primary mt-3" style="min-height: 44px;">
							<i class="ti ti-plus me-2"></i>
							{{ 'newTask'|trans }}
						</a>
					</div>
				</div>
			</div>
		{% endfor %}
	</div>

	{# Pagination #}
	<div class="d-flex justify-content-center mt-4">
		{{ pagination(tasks) }}
	</div>
{% endblock %}
