{% extends 'club/base.html.twig' %}

{% block page_title %}
	{{ 'newPlan'|trans }}
{% endblock %}

{% block page_content %}
	<div data-controller="plan-form confirm">
		{{ form_start(form) }}

		{# Main form fields card #}
		<div class="card mb-3">
			<div class="card-body">
				<div class="row">
					<div class="col-12 col-md-6 mb-3">
						{{ form_row(form.name) }}
					</div>
					<div class="col-12 col-md-6 mb-3">
						{{ form_row(form.equipmentType) }}
					</div>
				</div>
				<div class="mb-3">
					{{ form_row(form.description) }}
				</div>
			</div>
		</div>

		{# Tasks section #}
		<div class="mb-3">
			<h4>{{ 'tasks'|trans }}</h4>

			{# Tasks container #}
			<div
				data-plan-form-target="tasksContainer">
				{# Empty state placeholder #}
				<div class="text-center py-4 d-none" data-task-placeholder>
					<p class="text-muted mb-0">{{ 'noTasksInPlan'|trans }}</p>
				</div>

				{% for taskTemplate in form.taskTemplates %}
					<div class="card mb-3" data-task-index="{{ loop.index0 }}">
						<div class="card-header d-flex justify-content-between align-items-center">
							<h5 class="card-title mb-0">{{ 'task'|trans }}
								#{{ loop.index }}</h5>
							<button type="button" class="btn btn-sm btn-danger" data-action="click->plan-form#removeTask" data-confirm="{{ 'confirmDeleteTask'|trans }}" aria-label="{{ 'deleteThisTask'|trans }}">
								<i class="ti ti-trash"></i>
							</button>
						</div>
						<div class="card-body">
							<div class="mb-3">
								{{ form_row(taskTemplate.title) }}
							</div>
							<div class="mb-3">
								{{ form_row(taskTemplate.description) }}
							</div>

							{# Subtasks section #}
							<fieldset class="mt-3 border rounded p-3">
								<legend class="float-none w-auto px-2 fs-6 mb-3">{{ 'subTasks'|trans }}</legend>

								<div
									data-subtask-container>
									{# Empty state placeholder #}
									<div class="text-center py-2 d-none" data-subtask-placeholder>
										<p class="text-muted small mb-0">{{ 'noSubTasks'|trans }}</p>
									</div>

									{% for subTaskTemplate in taskTemplate.subTaskTemplates %}
										<fieldset class="form-fieldset mb-3" data-subtask-index="{{ loop.index0 }}">
											<legend class="d-flex justify-content-between align-items-center h5 mb-2">
												<span>{{ 'subTask'|trans }}
													{{ loop.parent.loop.index }}.{{ loop.index }}</span>
												<button type="button" class="btn btn-sm btn-danger" data-action="click->plan-form#removeSubTask" data-confirm="{{ 'confirmDeleteSubTask'|trans }}" aria-label="{{ 'deleteThisSubTask'|trans }}">
													<i class="ti ti-trash"></i>
												</button>
											</legend>
											<div class="row mb-2">
												<div class="col-12 col-md-9">
													{{ form_row(subTaskTemplate.title) }}
												</div>
												<div class="col-12 col-md-3">
													{{ form_row(subTaskTemplate.difficulty) }}
												</div>
											</div>
											<div class="mb-2">
												{{ form_row(subTaskTemplate.description) }}
											</div>
											<div class="mb-2">
												<div class="form-check form-switch">
													{{ form_widget(subTaskTemplate.requiresInspection, {'attr': {'class': 'form-check-input'}}) }}
													{{ form_label(subTaskTemplate.requiresInspection, null, {'label_attr': {'class': 'form-check-label'}}) }}
												</div>
											</div>
										</fieldset>
									{% endfor %}

									{# Add subtask button #}
									<div class="text-center" data-subtask-add-button>
										<button type="button" class="btn btn-sm btn-secondary" data-action="click->plan-form#addSubTask" aria-label="{{ 'addSubTask'|trans }}">
											<i class="ti ti-plus me-2"></i>
											{{ 'addSubTask'|trans }}
										</button>
									</div>
								</div>

								{# Subtask template (hidden) #}
								<template data-subtask-template>
									<fieldset class="form-fieldset mb-3" data-subtask-index="">
										<legend class="d-flex justify-content-between align-items-center h5 mb-2">
											<span>{{ 'subTask'|trans }}
												__PARENT_INDEX__.__SUBTASK_INDEX__</span>
											<button type="button" class="btn btn-sm btn-danger" data-action="click->plan-form#removeSubTask" data-confirm="{{ 'confirmDeleteSubTask'|trans }}" aria-label="{{ 'deleteThisSubTask'|trans }}">
												<i class="ti ti-trash"></i>
											</button>
										</legend>
										<div class="row mb-2">
											<div class="col-12 col-md-9">
												{{ form_row(taskTemplate.subTaskTemplates.vars.prototype.title) }}
											</div>
											<div class="col-12 col-md-3">
												{{ form_row(taskTemplate.subTaskTemplates.vars.prototype.difficulty) }}
											</div>
										</div>
										<div class="mb-2">
											{{ form_row(taskTemplate.subTaskTemplates.vars.prototype.description) }}
										</div>
										<div class="mb-2">
											<div class="form-check form-switch">
												{{ form_widget(taskTemplate.subTaskTemplates.vars.prototype.requiresInspection, {'attr': {'class': 'form-check-input'}}) }}
												{{ form_label(taskTemplate.subTaskTemplates.vars.prototype.requiresInspection, null, {'label_attr': {'class': 'form-check-label'}}) }}
											</div>
										</div>
									</fieldset>
								</template>
							</fieldset>
						</div>
					</div>
				{% endfor %}
			</div>

			{# Add task button #}
			<div class="text-center mt-3">
				<button type="button" class="btn btn-secondary" data-action="click->plan-form#addTask" aria-label="{{ 'addTask'|trans }}">
					<i class="ti ti-plus me-2"></i>
					{{ 'addTask'|trans }}
				</button>
			</div>
		</div>

		{# Task template (hidden) #}
		<template data-plan-form-target="taskTemplate">
			<div class="card mb-3" data-task-index="">
				<div class="card-header d-flex justify-content-between align-items-center">
					<h5 class="card-title mb-0">{{ 'task'|trans }}
						#__TASK_INDEX__</h5>
					<button type="button" class="btn btn-sm btn-danger" data-action="click->plan-form#removeTask" data-confirm="{{ 'confirmDeleteTask'|trans }}" aria-label="{{ 'deleteThisTask'|trans }}">
						<i class="ti ti-trash"></i>
					</button>
				</div>
				<div class="card-body">
					<div class="mb-3">
						{{ form_row(form.taskTemplates.vars.prototype.title) }}
					</div>
					<div class="mb-3">
						{{ form_row(form.taskTemplates.vars.prototype.description) }}
					</div>

					{# Subtasks section #}
					<fieldset class="mt-3 border rounded p-3">
						<legend class="float-none w-auto px-2 fs-6 mb-3">{{ 'subTasks'|trans }}</legend>

						<div
							data-subtask-container>
							{# Empty state placeholder #}
							<div class="text-center py-2 d-none" data-subtask-placeholder>
								<p class="text-muted small mb-0">{{ 'noSubTasks'|trans }}</p>
							</div>

							{# Add subtask button #}
							<div class="text-center" data-subtask-add-button>
								<button type="button" class="btn btn-sm btn-secondary" data-action="click->plan-form#addSubTask" aria-label="{{ 'addSubTask'|trans }}">
									<i class="ti ti-plus me-2"></i>
									{{ 'addSubTask'|trans }}
								</button>
							</div>
						</div>

						{# Subtask template (hidden) #}
						<template data-subtask-template>
							<fieldset class="form-fieldset mb-3" data-subtask-index="">
								<legend class="d-flex justify-content-between align-items-center h5 mb-2">
									<span>{{ 'subTask'|trans }}
										__PARENT_INDEX__.__SUBTASK_INDEX__</span>
									<button type="button" class="btn btn-sm btn-danger" data-action="click->plan-form#removeSubTask" data-confirm="{{ 'confirmDeleteSubTask'|trans }}" aria-label="{{ 'deleteThisSubTask'|trans }}">
										<i class="ti ti-trash"></i>
									</button>
								</legend>
								<div class="row mb-2">
									<div class="col-12 col-md-9">
										{{ form_row(form.taskTemplates.vars.prototype.subTaskTemplates.vars.prototype.title) }}
									</div>
									<div class="col-12 col-md-2">
										{{ form_row(form.taskTemplates.vars.prototype.subTaskTemplates.vars.prototype.difficulty) }}
									</div>
								</div>
								<div class="mb-2">
									{{ form_row(form.taskTemplates.vars.prototype.subTaskTemplates.vars.prototype.description) }}
								</div>
								<div class="mb-2">
									<div class="form-check form-switch">
										{{ form_widget(form.taskTemplates.vars.prototype.subTaskTemplates.vars.prototype.requiresInspection, {'attr': {'class': 'form-check-input'}}) }}
										{{ form_label(form.taskTemplates.vars.prototype.subTaskTemplates.vars.prototype.requiresInspection, null, {'label_attr': {'class': 'form-check-label'}}) }}
									</div>
								</div>
							</fieldset>
						</template>
					</fieldset>
				</div>
			</div>
		</template>

		{# Save button #}
		<div class="card mt-3 sticky-bottom-mobile">
			<div class="card-body d-flex gap-2">
				<button type="submit" class="btn btn-primary w-100">
					<i class="ti ti-device-floppy me-2"></i>
					{{ 'save'|trans }}
				</button>
			</div>
		</div>

		{% do form.taskTemplates.setRendered %}
		{{ form_end(form) }}
	</div>
{% endblock %}
