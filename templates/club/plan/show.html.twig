{% extends 'club/base.html.twig' %}

{% block page_title %}
	{{ plan.name }}
{% endblock %}

{% block page_actions %}
	{% if is_granted('MANAGE', club) %}
		<div class="btn-list" data-controller="confirm" data-confirm-title-value="{{ 'confirmDelete'|trans }}" data-confirm-yes-value="{{ 'delete'|trans }}" data-confirm-cancel-value="{{ 'cancel'|trans }}">
			<a href="{{ path('club_plan_export', {id: plan.id}) }}" class="btn">
				<i class="ti ti-file-spreadsheet me-2"></i>
				{{ 'exportPlan'|trans }}
			</a>
			{% if importForm is defined and importForm %}
				<button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#plan-import-modal">
					<i class="ti ti-upload me-2"></i>
					{{ 'importPlan'|trans }}
				</button>
			{% endif %}
			<a href="{{ path('club_plan_apply', {id: plan.id}) }}" class="btn btn-primary">
				<i class="ti ti-clipboard-check me-2"></i>
				{{ 'apply'|trans }}
			</a>
			<a href="{{ path('club_plan_edit', {id: plan.id}) }}" class="btn">
				<i class="ti ti-edit me-2"></i>
				{{ 'edit'|trans }}
			</a>
			<form method="post" action="{{ path('club_plan_delete', {id: plan.id}) }}" style="display: inline;">
				<input type="hidden" name="_token" value="{{ csrf_token('delete' ~ plan.id) }}">
				<button type="submit" class="btn btn-danger" data-confirm="{{ 'confirmDeletePlanMessage'|trans({'{planName}': plan.name}) }}">
					<i class="ti ti-trash me-2"></i>
					{{ 'delete'|trans }}
				</button>
			</form>
		</div>
	{% endif %}
{% endblock %}

{% block page_content %}
	{# Plan Information Card #}
	<div class="row row-cards mb-3">
		<div class="col-12">
			<div class="card">
				<div class="card-body">
					<div class="row align-items-center">
						<div class="col">
							<h3 class="card-title mb-2">{{ plan.name }}</h3>
							<div class="mb-2">
								<span class="badge bg-{{ plan.equipmentType.value == 'glider' ? 'blue' : 'green' }} text-white me-2">
									<i class="ti ti-{{ plan.equipmentType.value == 'glider' ? 'plane' : 'building' }} me-1"></i>
									{{ (plan.equipmentType.value ~ 'Type')|trans }}
								</span>
								<span class="badge bg-primary text-white me-2">
									<i class="ti ti-checkbox me-1"></i>
									{{ plan.taskTemplates|length }}
									{{ 'tasks'|trans|lower }}
								</span>
								{% set totalSubTasks = 0 %}
								{% for task in plan.taskTemplates %}
									{% set totalSubTasks = totalSubTasks + task.subTaskTemplates|length %}
								{% endfor %}
								{% if totalSubTasks > 0 %}
									<span class="badge bg-secondary text-white">
										<i class="ti ti-list-check me-1"></i>
										{{ totalSubTasks }}
										{{ 'subTasks'|trans|lower }}
									</span>
								{% endif %}
							</div>
							{% if plan.description %}
								<div class="text-secondary">
									{{ plan.description }}
								</div>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	{# Tasks List #}
	<div class="row row-cards">
		<div class="col-12">
			<div class="card">
				<div class="card-header">
					<h3 class="card-title">{{ 'tasks'|trans }}</h3>
				</div>
				<div class="card-body">
					{% if plan.taskTemplates|length > 0 %}
						{% for taskTemplate in plan.taskTemplates %}
							<div class="mb-4 {% if not loop.last %}pb-4 border-bottom{% endif %}">
								<div class="mb-2">
									<h4 class="mb-0">
										<span class="badge badge-outline text-primary me-2">{{ loop.index }}</span>
										{{ taskTemplate.title }}
									</h4>
								</div>

								{% if taskTemplate.description %}
									<p class="text-secondary mb-2">{{ taskTemplate.description }}</p>
								{% endif %}

								{# Subtasks #}
								{% if taskTemplate.subTaskTemplates|length > 0 %}
									<div class="mt-3">
										<div class="list-group list-group-flush">
											{% for subTaskTemplate in taskTemplate.subTaskTemplates %}
												<div class="list-group-item px-0">
													<div class="d-flex align-items-start justify-content-between">
														<div class="d-flex align-items-start flex-grow-1">
															<span class="badge badge-outline text-secondary me-2">{{ loop.parent.loop.index }}.{{ loop.index }}</span>
															<div class="flex-grow-1">
																<div class="fw-bold">{{ subTaskTemplate.title }}</div>
																{% if subTaskTemplate.description %}
																	<div class="text-secondary small">{{ subTaskTemplate.description }}</div>
																{% endif %}
															</div>
														</div>
														<div class="d-flex gap-2 align-items-start ms-3">
															{% if subTaskTemplate.requiresInspection %}
																<span class="badge bg-warning-lt text-white" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ 'requiresValidationTooltip'|trans }}">
																	<i class="ti ti-shield-check me-1"></i>
																	{{ 'requiresInspection'|trans }}
																</span>
															{% endif %}
															{% include 'component/difficultyBadge.html.twig' with {'difficulty': subTaskTemplate.difficulty} %}
														</div>
													</div>
												</div>
											{% endfor %}
										</div>
									</div>
								{% endif %}
							</div>
						{% endfor %}
					{% else %}
						<div class="empty">
							<div class="empty-icon">
								<i class="ti ti-checkbox icon-lg"></i>
							</div>
							<p class="empty-title">{{ 'noTasksInPlan'|trans }}</p>
							<p class="empty-subtitle text-secondary">
								{{ 'noTasksInPlanDescription'|trans }}
							</p>
							{% if is_granted('MANAGE', club) %}
								<div class="empty-action">
									<a href="{{ path('club_plan_edit', {id: plan.id}) }}" class="btn btn-primary">
										<i class="ti ti-plus"></i>
										{{ 'addTasks'|trans }}
									</a>
								</div>
							{% endif %}
						</div>
					{% endif %}
				</div>
			</div>
			{% if importForm is defined and importForm %}
				<div class="modal fade" id="plan-import-modal" tabindex="-1" aria-labelledby="plan-import-modal-label" aria-hidden="true">
					<div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" id="plan-import-modal-label">{{ 'importPlanFromXlsx'|trans }}</h5>
								<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ 'cancel'|trans }}"></button>
							</div>
							{{ form_start(importForm, {
								action: path('club_plan_import', {id: plan.id}),
								attr: {'enctype': 'multipart/form-data'}
							}) }}
							<div class="modal-body">
								<div class="alert alert-warning d-flex align-items-start gap-2">
									<i class="ti ti-alert-triangle mt-1"></i>
									<div>
										<div class="fw-semibold">{{ 'planImportWarningTitle'|trans }}</div>
										<div class="small text-muted">{{ 'planImportWarningMessage'|trans }}</div>
									</div>
								</div>
								<div class="mb-3">
									{{ form_row(importForm.file) }}
								</div>
								<div class="text-secondary small">{{ 'planImportHint'|trans }}</div>
							</div>
							<div class="modal-footer d-flex flex-column flex-sm-row gap-2">
								<button type="submit" class="btn btn-primary w-100 w-sm-auto">
									<i class="ti ti-upload me-2"></i>
									{{ 'importPlan'|trans }}
								</button>
							</div>
							{{ form_rest(importForm) }}
							{{ form_end(importForm) }}
						</div>
					</div>
				</div>
			{% endif %}
		</div>
	</div>

	{# Applications Section #}
	{% if applications|length > 0 %}
		<div class="row row-cards mt-3">
			<div class="col-12">
				<div class="card">
					<div class="card-header">
						<h3 class="card-title">{{ 'activeApplications'|trans }}</h3>
						<span class="badge bg-primary text-white ms-2">{{ applications|length }}</span>
					</div>
					<div class="card-body">
						<div class="list-group list-group-flush">
							{% for application in applications %}
								<a href="{{ path('club_plan_application_show', {id: application.id}) }}" class="list-group-item list-group-item-action px-0">
									<div class="row align-items-center">
										<div class="col">
											<div class="fw-bold mb-1">{{ application.equipment.name }}</div>
											<div class="text-secondary small mb-1">
												<i class="ti ti-calendar me-1"></i>
												{{ 'appliedAt'|trans }}:
												{{ application.appliedAt|date('d/m/Y') }}
											</div>
											<div class="text-secondary small">
												{% if application.dueAt %}
													<i class="ti ti-calendar-due me-1"></i>
													{{ 'dueDate'|trans }}:
													{{ application.dueAt|date('d/m/Y') }}
												{% else %}
													<i class="ti ti-calendar-x me-1"></i>
													{{ 'noDueDate'|trans }}
												{% endif %}
											</div>
										</div>
										<div class="col-auto">
											<div class="d-flex gap-2 align-items-center">
												<span class="badge bg-primary text-white">
													{{ application.tasks|length }}
													{{ 'tasks'|trans|lower }}
												</span>
												{% if application.isCancelled %}
													<span class="badge bg-warning-lt text-white">
														<i class="ti ti-x me-1"></i>
														{{ 'cancelled'|trans }}
													</span>
												{% endif %}
											</div>
										</div>
									</div>

									{# Progress bar for tasks #}
									{% if application.tasks|length > 0 %}
										{% set progress = 0 %}
										{% set closed = 0 %}
										{% for task in application.tasks %}
											{% if task.status == 'closed' %}
												{% set closed = closed + 1 %}
											{% endif %}
										{% endfor %}
										{% set progress = (closed / application.tasks|length * 100)|round %}
										<div class="progress progress-sm mb-1 mt-2">
											<div class="progress-bar bg-{{ progress == 100 ? 'success' : 'primary' }}" style="width: {{ progress }}%">
												<span class="visually-hidden">{{ progress }}%</span>
											</div>
										</div>
										<div class="text-secondary small">
											{{ closed }}
											/
											{{ application.tasks|length }}
											{{ 'tasks'|trans|lower }}
											{{ 'completed'|trans|lower }}
										</div>
									{% endif %}
								</a>
							{% endfor %}
						</div>
					</div>
				</div>
			</div>
		</div>
	{% endif %}
{% endblock %}
