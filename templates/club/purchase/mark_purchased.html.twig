{% extends 'club/base.html.twig' %}

{% block page_title %}
	{{ 'markAsPurchased'|trans }}
{% endblock %}

{% block page_content %}
	<div class="card">
		<div class="card-body">
			<div class="mb-4">
				<h3>{{ purchase.name }}</h3>
				<div class="text-secondary">{{ 'purchaseQuantity'|trans }}:
					{{ purchase.quantity }}</div>
			</div>

			{{ form_start(form) }}

			{# Who purchased it - only show for managers #}
			{% if isManager and form.purchasedByMembership is defined %}
				<fieldset class="form-fieldset mb-3 pt-1" data-controller="user-list-filter" data-user-list-filter-type-value="purchasedByMembership">
					{{ form_label(form.purchasedByMembership) }}

					{# Search input #}
					<div class="mb-3">
						<input type="text" class="form-control" placeholder="{{ 'searchMember'|trans }}..." data-user-list-filter-target="search" data-action="input->user-list-filter#filter">
					</div>

					<div class="d-flex flex-column border rounded p-0" style="max-height: 250px; overflow-y: auto; background-color: #fff;">
						{% for child in form.purchasedByMembership %}
							<label class="d-flex align-items-center m-0 p-2 border-bottom" data-user-list-filter-target="item" style="cursor: pointer;">
								<input type="radio" name="{{ child.vars.full_name }}" value="{{ child.vars.value }}" class="form-check-input me-2 m-0" {% if child.vars.checked %} checked {% endif %} required>
								<span class="mb-0">{{ child.vars.label }}</span>
							</label>
						{% endfor %}
						<div class="text-center text-secondary py-3 d-none" data-user-list-filter-target="empty">
							<em>{{ 'noMemberFound'|trans }}</em>
						</div>
					</div>
					{{ form_errors(form.purchasedByMembership) }}
				</fieldset>
			{% else %}
				{# For non-managers, hide the field but keep it in the form #}
				<div style="display: none;">
					{% if form.purchasedByMembership is defined %}
						{{ form_row(form.purchasedByMembership) }}
					{% endif %}
				</div>
			{% endif %}

			{# Mark field as rendered if we rendered it manually #}
			{% if isManager and form.purchasedByMembership is defined %}
				{% do form.purchasedByMembership.setRendered %}
			{% endif %}

			{# Uploaded Files - 2 Column Layout #}
			<div
				class="row g-3 mb-3">
				{# Request Image Column - Editable #}
				<div class="col-12 col-md-6">
					<div class="uploaded-file-cell">
						<div class="uploaded-file-header">
							<label class="form-label mb-2">{{ 'purchaseRequestImageOrPdf'|trans }}</label>
						</div>
						<div class="uploaded-file-content">
							{{ form_errors(form.requestImage) }}

							<div class="uploaded-file-grid" data-controller="file-input-trigger">
								<div class="row g-2 align-items-end">
									<div class="col">
										{{ form_widget(form.requestImage) }}
									</div>
									{% if purchase.requestImage and is_granted('PURCHASE_EDIT', purchase) %}
										<div class="col-auto" data-controller="confirm" data-confirm-title-value="{{ 'confirmDelete'|trans }}" data-confirm-yes-value="{{ 'delete'|trans }}" data-confirm-cancel-value="{{ 'cancel'|trans }}">
											<a href="{{ path('club_purchase_delete_request_image', {id: purchase.id, _token: csrf_token('del_req_img' ~ purchase.id)}) }}" class="btn btn-outline-danger btn-sm" data-confirm="{{ 'confirmDeleteRequestImage'|trans }}">
												<i class="ti ti-trash me-2"></i>
												{{ 'deleteFile'|trans }}
											</a>
										</div>
									{% endif %}
								</div>

								{# Thumbnail, document, or placeholder - clickable #}
								<div class="row mt-3">
									<div class="col-12">
										{% if purchase.requestImage %}
											{% if purchase.requestImage matches '/\\.(jpg|jpeg|png|gif|webp)$/i' %}
												<div class="uploaded-file-thumbnail" data-action="click->file-input-trigger#trigger" style="cursor: pointer;">
													<img src="{{ purchase.requestImage }}" alt="{{ 'purchaseRequestImage'|trans }}">
												</div>
											{% else %}
												<div class="uploaded-file-document" data-action="click->file-input-trigger#trigger" style="cursor: pointer;">
													<div class="uploaded-file-document-icon">
														<i class="ti ti-file-type-pdf"></i>
													</div>
													<div class="uploaded-file-document-label">
														{{ 'pdfDocument'|trans }}
													</div>
													<div class="uploaded-file-document-action">
														<a href="{{ purchase.requestImage }}" target="_blank" rel="noopener noreferrer" class="btn btn-primary btn-sm" style="min-height: 44px;" onclick="event.stopPropagation();">
															<i class="ti ti-external-link me-2"></i>
															{{ 'viewFile'|trans }}
														</a>
													</div>
												</div>
											{% endif %}
										{% else %}
											<div class="uploaded-file-empty" data-action="click->file-input-trigger#trigger" style="cursor: pointer;">
												<i class="ti ti-photo fs-1 text-muted mb-2"></i>
												<div class="text-muted">{{ 'clickToUploadImage'|trans }}</div>
											</div>
										{% endif %}
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				{# Bill Image Column - Editable #}
				<div class="col-12 col-md-6">
					<div class="uploaded-file-cell">
						<div class="uploaded-file-header">
							<label class="form-label mb-2">{{ 'purchaseBillImageOrPdf'|trans }}</label>
						</div>
						<div class="uploaded-file-content">
							{{ form_errors(form.billImage) }}

							<div class="uploaded-file-grid" data-controller="file-input-trigger">
								<div class="row g-2 align-items-end">
									<div class="col">
										{{ form_widget(form.billImage) }}
									</div>
									{% if purchase.billImage and is_granted('PURCHASE_EDIT', purchase) %}
										<div class="col-auto" data-controller="confirm" data-confirm-title-value="{{ 'confirmDelete'|trans }}" data-confirm-yes-value="{{ 'delete'|trans }}" data-confirm-cancel-value="{{ 'cancel'|trans }}">
											<a href="{{ path('club_purchase_delete_bill_image', {id: purchase.id, _token: csrf_token('del_bill_img' ~ purchase.id)}) }}" class="btn btn-outline-danger btn-sm" data-confirm="{{ 'confirmDeleteBillImage'|trans }}">
												<i class="ti ti-trash me-2"></i>
												{{ 'deleteFile'|trans }}
											</a>
										</div>
									{% endif %}
								</div>

								{# Thumbnail, document, or placeholder - clickable #}
								<div class="row mt-3">
									<div class="col-12">
										{% if purchase.billImage %}
											{% if purchase.billImage matches '/\\.(jpg|jpeg|png|gif|webp)$/i' %}
												<div class="uploaded-file-thumbnail" data-action="click->file-input-trigger#trigger" style="cursor: pointer;">
													<img src="{{ purchase.billImage }}" alt="{{ 'purchaseBillImage'|trans }}">
												</div>
											{% else %}
												<div class="uploaded-file-document" data-action="click->file-input-trigger#trigger" style="cursor: pointer;">
													<div class="uploaded-file-document-icon">
														<i class="ti ti-file-type-pdf"></i>
													</div>
													<div class="uploaded-file-document-label">
														{{ 'pdfDocument'|trans }}
													</div>
													<div class="uploaded-file-document-action">
														<a href="{{ purchase.billImage }}" target="_blank" rel="noopener noreferrer" class="btn btn-primary btn-sm" style="min-height: 44px;" onclick="event.stopPropagation();">
															<i class="ti ti-external-link me-2"></i>
															{{ 'viewBill'|trans }}
														</a>
													</div>
												</div>
											{% endif %}
										{% else %}
											<div class="uploaded-file-empty" data-action="click->file-input-trigger#trigger" style="cursor: pointer;">
												<i class="ti ti-photo fs-1 text-muted mb-2"></i>
												<div class="text-muted">{{ 'clickToUploadImage'|trans }}</div>
											</div>
										{% endif %}
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			{# Mark requestImage and billImage fields as rendered since we rendered them manually #}
			{% do form.requestImage.setRendered %}
			{% do form.billImage.setRendered %}

			<div class="form-footer">
				<button type="submit" class="btn btn-primary" style="min-height: 44px;">
					<i class="ti ti-check me-2"></i>
					{{ 'markAsPurchased'|trans }}
				</button>
				<a href="{{ path('club_purchase_show', {id: purchase.id}) }}" class="btn btn-secondary" style="min-height: 44px;">
					{{ 'cancel'|trans }}
				</a>
			</div>
			{{ form_end(form) }}
		</div>
	</div>
{% endblock %}
