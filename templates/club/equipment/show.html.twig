{% extends 'club/base.html.twig' %}

{% block page_title %}
	{{ equipment.name }}
{% endblock %}

{% block page_actions %}
	<div
		class="d-flex gap-2 flex-wrap">
		{# View all tasks for this equipment #}
		<a href="{{ path('club_tasks', {'filters[equipment]': equipment.id, 'filters[status]': 'open'}) }}" class="btn btn-outline-primary" style="min-height: 44px;">
			<i class="ti ti-checklist me-2"></i>
			<span class="d-none d-sm-inline">{{ 'viewTasks'|trans }}</span>
			<span class="d-inline d-sm-none">{{ 'tasks'|trans }}</span>
		</a>

		{% if is_granted('MANAGE', club) %}
			<a href="{{ path('club_equipment_edit', {id: equipment.id}) }}" class="btn btn-primary" style="min-height: 44px;">
				<i class="ti ti-edit me-2"></i>
				<span class="d-none d-sm-inline">{{ 'edit'|trans }}</span>
				<span class="d-inline d-sm-none">{{ 'edit'|trans }}</span>
			</a>
			{% if equipment.active %}
				<form method="post" action="{{ path('club_equipment_disable', {id: equipment.id}) }}" class="d-inline" onsubmit="return confirm('{{ 'confirmDisableEquipment'|trans }}');">
					<button type="submit" class="btn btn-outline-danger" style="min-height: 44px;">
						<i class="ti ti-x me-2"></i>
						<span class="d-none d-sm-inline">{{ 'disable'|trans }}</span>
						<span class="d-inline d-sm-none">{{ 'disable'|trans }}</span>
					</button>
				</form>
			{% else %}
				<form method="post" action="{{ path('club_equipment_enable', {id: equipment.id}) }}" class="d-inline">
					<button type="submit" class="btn btn-outline-success" style="min-height: 44px;">
						<i class="ti ti-check me-2"></i>
						<span class="d-none d-sm-inline">{{ 'reactivate'|trans }}</span>
						<span class="d-inline d-sm-none">{{ 'reactivate'|trans }}</span>
					</button>
				</form>
			{% endif %}
		{% endif %}
	</div>
{% endblock %}

{% block page_content %}
	{# Main equipment card #}
	<div class="card mb-3">
		<div class="card-body">
			<div
				class="d-flex align-items-center mb-4">
			{# Avatar with icon based on type #}
			<span class="avatar avatar-xl me-3 bg-{{ equipment.type.color }}-lt">
				<i class="ti {{ equipment.type.icon }} text-{{ equipment.type.color }}" style="font-size: 2.5rem;"></i>
			</span>
				<div class="flex-fill">
					<h2 class="mb-1">{{ equipment.name }}</h2>
					<div class="text-secondary h4 mb-0">
						{{ equipment.type.label|trans }}
					</div>
				</div>
			</div>

			<hr
			class="my-4">

			{# Equipment details #}
			<div class="row">
				<div class="col-12 col-md-6 mb-3">
					<div class="text-secondary small mb-1">{{ 'type'|trans }}</div>
					<div>
					<span class="badge bg-{{ equipment.type.color }}-lt">
						{{ equipment.type.label|trans }}
					</span>
					</div>
				</div>

				<div class="col-12 col-md-6 mb-3">
					<div class="text-secondary small mb-1">{{ 'status'|trans }}</div>
					<div>
						{% if equipment.active %}
							<span class="badge bg-success-lt">
								<i class="ti ti-check me-1"></i>
								{{ 'active'|trans }}
							</span>
						{% else %}
							<span class="badge bg-secondary-lt">
								<i class="ti ti-x me-1"></i>
								{{ 'inactive'|trans }}
							</span>
						{% endif %}
					</div>
				</div>

				<div class="col-12 col-md-6 mb-3">
					<div class="text-secondary small mb-1">{{ 'owner'|trans }}</div>
					<div>
						{% if equipment.isPrivate %}
							<span class="badge badge-private">
								<i class="ti ti-user me-1"></i>
								{{ 'private'|trans }}
							</span>
						{% else %}
							<span class="badge bg-blue-lt">
								<i class="ti ti-building me-1"></i>
								{{ 'club'|trans }}
							</span>
						{% endif %}
					</div>
				</div>

				<div class="col-12 col-md-6 mb-3">
					<div class="text-secondary small mb-1">{{ 'createdAt'|trans }}</div>
					<div>
						<i class="ti ti-calendar me-1"></i>
						{{ equipment.createdAt|date('d/m/Y Ã  H:i') }}
					</div>
				</div>

				{% if equipment.createdBy %}
					<div class="col-12 col-md-6 mb-3">
						<div class="text-secondary small mb-1">{{ 'createdBy'|trans }}</div>
						<div>
							<i class="ti ti-user me-1"></i>
							{{ equipment.createdBy.fullname }}
						</div>
					</div>
				{% endif %}

				{% if equipment.responsible %}
					<div class="col-12 col-md-6 mb-3">
						<div class="text-secondary small mb-1">{{ 'responsible'|trans }}</div>
						<div>
							<i class="ti ti-user-shield me-1"></i>
							{{ equipment.responsible.fullname }}
						</div>
					</div>
				{% endif %}

				{% if equipment.isPrivate and equipment.owners|length > 0 %}
					<div class="col-12 mb-3">
						<div class="text-secondary small mb-2">{{ 'owners'|trans }}</div>
						<div class="d-flex flex-wrap gap-2">
							{% for owner in equipment.owners %}
								<span class="badge bg-azure-lt">
									<i class="ti ti-user me-1"></i>
									{{ owner.fullname ?: owner.email }}
								</span>
							{% endfor %}
						</div>
					</div>
				{% endif %}
			</div>
		</div>
	</div>

	{# Plan Applications Section #}
	{% if applications|length > 0 %}
		<div class="card mb-3">
			<div class="card-header">
				<h3 class="card-title">
					<i class="ti ti-clipboard-check me-2"></i>
					{{ 'maintenancePlans'|trans }}
				</h3>
				<span class="badge bg-primary text-white ms-2">{{ applications|length }}</span>
			</div>
			<div class="list-group list-group-flush">
				{% for application in applications %}
					<a href="{{ path('club_plan_application_show', {id: application.id}) }}" class="list-group-item list-group-item-action">
						<div class="d-flex justify-content-between align-items-start mb-2">
							<div class="flex-grow-1">
								<div class="fw-bold">{{ application.plan.name }}</div>
								<div class="text-secondary small">
									<i class="ti ti-calendar me-1"></i>
									{{ 'appliedAt'|trans }}: {{ application.appliedAt|date('d/m/Y') }}
								</div>
								{% if application.dueAt %}
									<div class="text-secondary small">
										<i class="ti ti-calendar-due me-1"></i>
										{{ 'dueDate'|trans }}: {{ application.dueAt|date('d/m/Y') }}
									</div>
								{% endif %}
							</div>
							<div class="d-flex gap-2 align-items-center">
								<span class="badge bg-primary text-white">
									{{ application.tasks|length }} {{ 'tasks'|trans|lower }}
								</span>
								{% if application.isCancelled %}
									<span class="badge bg-warning-lt text-white">
										<i class="ti ti-x me-1"></i>
										{{ 'cancelled'|trans }}
									</span>
								{% endif %}
							</div>
						</div>

						{# Progress bar for tasks #}
						{% if application.tasks|length > 0 %}
							{% set progress = 0 %}
							{% set closed = 0 %}
							{% for task in application.tasks %}
								{% if task.status == 'closed' %}
									{% set closed = closed + 1 %}
								{% endif %}
							{% endfor %}
							{% set progress = (closed / application.tasks|length * 100)|round %}
							<div class="progress progress-sm mb-1">
								<div class="progress-bar bg-{{ progress == 100 ? 'success' : 'primary' }}" style="width: {{ progress }}%">
									<span class="visually-hidden">{{ progress }}%</span>
								</div>
							</div>
							<div class="text-secondary small">
								{{ closed }} / {{ application.tasks|length }} {{ 'tasks'|trans|lower }} {{ 'completed'|trans|lower }}
							</div>
						{% endif %}
					</a>
				{% endfor %}
			</div>
			{% if is_granted('MANAGE', club) %}
				<div class="card-footer">
					<a href="{{ path('club_equipment_apply_plan', {id: equipment.id}) }}" class="btn btn-primary w-100" style="min-height: 44px;">
						<i class="ti ti-clipboard-plus me-2"></i>
						{{ 'applyNewPlan'|trans }}
					</a>
				</div>
			{% endif %}
		</div>
	{% elseif is_granted('MANAGE', club) %}
		<div class="card mb-3">
			<div class="card-body">
				<div class="empty">
					<div class="empty-icon">
						<i class="ti ti-clipboard-check icon-lg"></i>
					</div>
					<p class="empty-title">{{ 'noMaintenancePlans'|trans }}</p>
					<p class="empty-subtitle text-secondary">
						{{ 'noMaintenancePlansDescription'|trans }}
					</p>
					<div class="empty-action">
						<a href="{{ path('club_equipment_apply_plan', {id: equipment.id}) }}" class="btn btn-primary">
							<i class="ti ti-clipboard-plus me-2"></i>
							{{ 'applyNewPlan'|trans }}
						</a>
					</div>
				</div>
			</div>
		</div>
	{% endif %}

	{# Pending Tasks Section #}
	{% if pendingTasks|length > 0 %}
		<div class="card mb-3">
			<div class="card-header">
				<h3 class="card-title">
					<i class="ti ti-checklist me-2"></i>
					{{ 'pendingTasks'|trans }}
				</h3>
			</div>
			<div class="list-group list-group-flush">
				{% for task in pendingTasks %}
					<a href="{{ path('club_task_show', {id: task.id}) }}" class="list-group-item list-group-item-action">
						<div class="d-flex align-items-center mb-2">
							<div class="flex-grow-1">
								<div class="fw-bold">{{ task.title }}</div>
								{% if task.dueAt %}
									<div class="text-secondary small">
										<i class="ti ti-calendar me-1"></i>
										{{ task.dueAt|date('d/m/Y') }}
									</div>
								{% endif %}
							</div>
							<div
								class="d-flex gap-2 align-items-center">
								{# Difficulty badge #}
								{% include 'component/difficultyBadge.html.twig' with {difficulty: task.difficulty} %}

							{# Inspection badge #}
							{% if task.requiresInspection %}
								<span class="badge bg-warning-lt text-white" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ 'requiresValidationTooltip'|trans }}">
									<i class="ti ti-shield-check me-1"></i>
									{{ 'requiresInspection'|trans }}
								</span>
							{% endif %}
							</div>
						</div>

						{# Progress bar for subtasks #}
						{% if task.subTasks|length > 0 %}
							{% set progress = 0 %}
							{% set closed = 0 %}
							{% for subtask in task.subTasks %}
								{% if subtask.status == 'closed' %}
									{% set closed = closed + 1 %}
								{% endif %}
							{% endfor %}
							{% set progress = (closed / task.subTasks|length * 100)|round %}
							<div class="progress progress-sm mb-1">
								<div class="progress-bar bg-{{ progress == 100 ? 'success' : 'primary' }}" style="width: {{ progress }}%">
									<span class="visually-hidden">{{ progress }}%</span>
								</div>
							</div>
							<div class="text-secondary small">
								{{ closed }}
								/
								{{ task.subTasks|length }}
								{{ 'subTasks'|trans|lower }}
							</div>
						{% endif %}
					</a>
				{% endfor %}
			</div>
			<div class="card-footer">
				<a href="{{ path('club_tasks', {'filters[equipment]': equipment.id, 'filters[status]': 'open'}) }}" class="btn btn-primary w-100" style="min-height: 44px;">
					{{ 'viewAllTasks'|trans }}
				</a>
			</div>
		</div>
	{% endif %}
{% endblock %}
