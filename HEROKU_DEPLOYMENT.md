# Heroku Deployment Guide for Tarmac

This document describes how to deploy the Tarmac application to Heroku using automatic deployment.

## Prerequisites

- Heroku CLI installed (`brew tap heroku/brew && brew install heroku`)
- Access to the Heroku account/team
- Git repository

## Heroku Configuration Files

The following files have been configured for Heroku deployment:

### Core Files

- **`Procfile`**: Defines the web process and release process
  - `web`: Starts the PHP Apache server after clearing cache and compiling assets
  - `release`: Runs migrations and asset compilation before deployment

- **`.php-version`**: Specifies PHP 8.3 for the Heroku PHP buildpack

- **`php.ini`**: PHP configuration for production
  - Memory limit: 256M
  - Execution time: 60s
  - OpCache enabled for performance

- **`app.json`**: Heroku app configuration
  - Environment variables
  - Add-ons (PostgreSQL)
  - Formation (dyno types and quantities)

### Deployment Scripts

- **`bin/release`**: Release phase script (runs automatically on every deploy)
  - Runs database migrations
  - Clears cache
  - Compiles asset maps

- **`bin/deploy`**: Manual deployment script (for local/server deployments)
  - Installs dependencies
  - Compiles assets
  - Runs migrations
  - Sets file permissions

## Environment Variables

The following environment variables are required/recommended for Heroku:

### Required Variables

- `APP_ENV`: Application environment (e.g., `prod`, `review`, `staging`)
- `APP_SECRET`: Secret key for encryption (auto-generated by Heroku)
- `DATABASE_URL`: Database connection string (auto-configured by PostgreSQL add-on)
- `DOMAIN`: Application domain for cookies and URLs
- `TRUSTED_PROXIES`: Trusted proxy IPs (set to `10.0.0.0/8,172.16.0.0/12,192.168.0.0/16` for Heroku)
- `TZ`: Timezone (e.g., `Europe/Paris`)

### Optional Variables

- `MAILER_DSN`: Mailer configuration for sending emails
- `MAILER_FROM_EMAIL`: From email address for system emails (e.g., `noreply@tarmac.app`)
- `MAILER_ADMIN_EMAIL`: Admin email address for critical error alerts
- `PROFILER_ALLOWED_IPS`: IP addresses allowed to access the web profiler

### AWS S3 Configuration (Optional)

If you want to use AWS S3 for file storage:

- `AWS_S3_URL`: AWS S3 base URL
- `AWS_S3_REGION`: AWS region (e.g., `eu-west-3`)
- `AWS_S3_BUCKET`: S3 bucket name
- `AWS_S3_ACCESS_ID`: AWS access key ID
- `AWS_S3_ACCESS_SECRET`: AWS secret access key

## Initial Setup

### 1. Create a Heroku App

```bash
heroku create your-app-name
```

Or use an existing app:

```bash
heroku git:remote -a your-app-name
```

### 2. Add PostgreSQL Add-on

```bash
heroku addons:create heroku-postgresql:essential-0
```

### 3. Configure Environment Variables

```bash
heroku config:set APP_ENV=prod
heroku config:set DOMAIN=herokuapp.com
heroku config:set TZ=Europe/Paris
heroku config:set TRUSTED_PROXIES="10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
```

Generate a secure APP_SECRET:

```bash
heroku config:set APP_SECRET=$(openssl rand -hex 32)
```

### 4. Enable Automatic Deployment (Optional)

In the Heroku Dashboard:
1. Go to your app's "Deploy" tab
2. Connect to your GitHub repository
3. Enable "Automatic Deploys" from your main branch
4. Optionally enable "Wait for CI to pass before deploy"

### 5. Manual Deploy

```bash
git push heroku main
```

Or trigger a deploy from the Heroku Dashboard.

## Manual Deployment Commands

### Run Migrations

```bash
heroku run php bin/console doctrine:migrations:migrate --no-interaction
```

### Clear Cache

```bash
heroku run php bin/console cache:clear
```

### Load Fixtures (Dev/Staging only - NOT for production)

```bash
heroku run php bin/console doctrine:fixtures:load --no-interaction
```

**Warning:** Only use fixtures on non-production environments!

### Access Console

```bash
heroku run php bin/console
```

### View Logs

```bash
heroku logs --tail
```

## Scaling

### Scale Web Dynos

```bash
heroku ps:scale web=1
```

### Change Dyno Type

```bash
heroku ps:type web=standard-1x
```

## Database Management

### Backup Database

```bash
heroku pg:backups:capture
```

### Download Latest Backup

```bash
heroku pg:backups:download
```

### Restore Database

```bash
heroku pg:backups:restore
```

## Troubleshooting

### Check Dyno Status

```bash
heroku ps
```

### Restart Dynos

```bash
heroku restart
```

### Check Environment Variables

```bash
heroku config
```

### Run One-off Commands

```bash
heroku run bash
```

## Performance Optimization

1. **OpCache**: Enabled by default in `php.ini`
2. **Asset Compilation**: Assets are pre-compiled during the release phase
3. **Cache Warming**: Cache is warmed up during deployment
4. **Database**: Use appropriate PostgreSQL plan for your needs

## Security Considerations

1. **Trusted Proxies**: Configured for Heroku's proxy infrastructure
2. **Secure Cookies**: Enabled in framework configuration
3. **Environment Variables**: Never commit secrets to Git
4. **Database Credentials**: Managed by Heroku PostgreSQL add-on

## Mobile-First Considerations

Tarmac is a mobile-first application. Ensure:

1. **Performance Testing**: Test on 3G networks
2. **Responsive Images**: Optimize images for mobile
3. **Touch Interactions**: Test on real mobile devices
4. **Lighthouse Scores**: Monitor mobile performance scores

## Deployment Workflow

1. **Push to main branch** (or connected branch)
2. **Heroku automatically detects the push** (if automatic deploys enabled)
3. **Build phase**: Heroku installs dependencies and builds the app
4. **Release phase**: `bin/release` script runs
   - Migrations are executed
   - Cache is cleared
   - Assets are compiled
5. **Deploy phase**: New version goes live
6. **Web dyno starts**: Procfile `web` process starts serving traffic

## Production Checklist

Before deploying to production:

- [ ] All environment variables configured
- [ ] Database add-on provisioned
- [ ] APP_ENV set to `prod`
- [ ] DOMAIN set to actual production domain
- [ ] Mailer configured (if sending emails)
- [ ] Backups scheduled
- [ ] Monitoring configured
- [ ] SSL certificate configured (automatic on Heroku)
- [ ] Custom domain configured (if applicable)
- [ ] Automatic deploys enabled (optional)

## Additional Resources

- [Heroku PHP Documentation](https://devcenter.heroku.com/categories/php-support)
- [Symfony Heroku Guide](https://symfony.com/doc/current/deployment/heroku.html)
- [Heroku PostgreSQL](https://devcenter.heroku.com/articles/heroku-postgresql)

